(()=>{"use strict";function t(e){let t=document.querySelector(".todos-wrapper");for(;t.firstChild;)t.removeChild(t.firstChild);class s{constructor(e,t,s){this.description=e,this.state=t,this.index=s,this.parent=document.querySelector(".todos-wrapper")}render(){const e=document.createElement("div");e.innerHTML=`\n            <div class="todo-item ${"done"==this.state?"checked":""}" id='${this.index}'>\n                <div class="description">${this.description}</div>\n                <div class="buttons">\n                    <input class="btn-complete" type="checkbox" ${"done"==this.state?"checked":""}>\n                    <button class="btn-delete">Удалить</button>\n                </div>\n            </div>\n            `,this.parent.append(e)}}e.forEach((({description:e,state:t},a)=>{new s(e,t,a).render()}))}const s=document.querySelector(".todos-wrapper"),a=document.querySelector(".flex-wrapper-todo"),n=a.querySelector("#description-task"),o=a.querySelector("#add-task-btn"),r=document.querySelector(".flex-wrapper-login"),i=r.querySelector("#login-btn"),c=r.querySelector("#username"),l=document.querySelector(".show-username"),d=l.querySelector("#exit-btn"),u=new class{_apiBase="http://127.0.0.1:1080/";headers={"Content-Type":"application/json"};request=async(e,t,s,a=null)=>{try{const n=await fetch(`${this._apiBase}${e}`,{method:t,headers:s,body:a,credentials:"include"});if(!n.ok)throw new Error(`Could not fetch ${this._apiBase}${e}, status: ${n.status}`);return n}catch(e){throw e}};login=async e=>await this.request("login","POST",this.headers,e);getTasks=async()=>await this.request("task","GET",this.headers);updateTasks=async e=>await this.request("task","PUT",this.headers,e);addTasks=async e=>await this.request("task","POST",this.headers,e);deleteTasks=async e=>await this.request("task","DELETE",this.headers,e)};let h=[];const p=()=>{const e=h.length?h.filter((e=>"open"==e.state)):[],t=h.length?h.filter((e=>"done"==e.state)):[];h=[...e,...t]};function y(e){e&&e==localStorage.getItem("username")?(r.style.display="none",a.style.display="block",l.style.display="block",l.querySelector("h2").innerHTML=`Пользователь: ${localStorage.getItem("username")}`):(r.style.display="block",a.style.display="none",l.style.display="none")}async function m(){await u.login(JSON.stringify({username:localStorage.getItem("username")})),await u.getTasks().then((e=>e.text())).then((e=>e?JSON.parse(e):[])).then((e=>h=e)).catch((e=>console.log(e))),p(),t(h)}function g(e,t,s){e.addEventListener("click",(e=>{e.target&&e.target.matches(t)&&s(e.target.parentNode.parentNode.getAttribute("id"))}))}document.addEventListener("DOMContentLoaded",(()=>{localStorage.getItem("username")&&m()})),y(localStorage.getItem("username")),i.addEventListener("click",(()=>{console.log(h),localStorage.getItem("username")!=c.value&&localStorage.setItem("username",c.value),m(),y(c.value),c.value=""})),d.addEventListener("click",(()=>{localStorage.setItem("username",""),y("")})),o.addEventListener("click",(()=>{try{async function s(){await u.getTasks().then((e=>e.text())).then((e=>e?JSON.parse(e):[])).then((e=>h=[{description:n.value,state:"open"},...e])).catch((e=>console.log(e))),u.updateTasks(JSON.stringify(h)),t(h),n.value=""}s()}catch(a){throw e}})),g(s,"input.btn-complete",(function(e){"open"==h[e].state?(h[e].state="done",document.getElementById(`${e}`).classList.add("checked"),u.updateTasks(JSON.stringify(h)),p(),t(h)):(h[e].state="open",document.getElementById(`${e}`).classList.remove("checked"),u.updateTasks(JSON.stringify(h)),p(),t(h))})),g(s,"button.btn-delete",(function(e){document.getElementById(`${e}`).classList.add("removing"),h.splice(e,1),u.updateTasks(JSON.stringify(h)),setTimeout((()=>{p(),t(h)}),500)}))})();